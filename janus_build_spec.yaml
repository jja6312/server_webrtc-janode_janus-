version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  variables:
    APP_NAME: "nodejs-janus-app"
    NODE_VERSION: "18.19.0"
    NODE_PREFIX: "/usr/local/node"          # 전역 설치 위치

steps:
  # 1) 공용 이미지 세팅 ‑ Node 18 + 최신 gcc
  - type: Command
    name: "Prepare build toolchain"
    command: |
      set -e
      echo "==> Enable OL7 developer repos & install devtoolset‑11"
      yum install -y oracle‑linux‑developer‑release‑el7
      yum-config-manager --enable ol7_developer
      yum install -y devtoolset-11

      echo "==> Install Node ${NODE_VERSION}"
      curl -fsSL https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz -o /tmp/node.tar.xz
      mkdir -p ${NODE_PREFIX}
      tar -xf /tmp/node.tar.xz -C ${NODE_PREFIX} --strip-components=1
      ln -sf ${NODE_PREFIX}/bin/* /usr/local/bin/        # 다음 스텝에서도 그대로 사용 가능

  # 2) 애플리케이션 의존성 설치 (devtoolset‑11 활성화)
  - type: Command
    name: "Install OS libs & build Node modules"
    command: |
      set -e
      # 최신 gcc 활성화
      source /opt/rh/devtoolset-11/enable
      export CC=gcc CXX=g++
      echo "==> gcc version: $(gcc -v 2>&1 | tail -1)"
      echo "==> node version: $(node -v)"

      echo "==> Janus/Janode native deps"
      yum install -y \
        libmicrohttpd-devel jansson-devel openssl-devel libsrtp-devel \
        sofia-sip-devel glib2-devel opus-devel libogg-devel libcurl-devel \
        lua-devel libconfig-devel pkgconfig gengetopt libtool automake \
        make gcc gcc-c++ mysql-devel nice-devel

      echo "==> npm install"
      cd media_app/janode
      npm ci                       # reproducible build

  # 3) 배포 아티팩트 패키징
  - type: Command
    name: "Package artifact"
    command: |
      set -e
      mkdir -p ${OCI_WORKSPACE_DIR}/deployment
      cp -r media_app ${OCI_WORKSPACE_DIR}/deployment/
      cd ${OCI_WORKSPACE_DIR}/deployment
      tar -czf nodejs-janus-app.tar.gz media_app

outputArtifacts:
  - name: nodejs-janus-app-artifact
    type: BINARY
    location: ${OCI_WORKSPACE_DIR}/deployment/nodejs-janus-app.tar.gz
